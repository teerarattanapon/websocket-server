<html>

<head>
<script src='https://cdnjs.cloudflare.com/ajax/libs/Chart.js/1.0.2/Chart.min.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
<script>
//timer1 for check alarm
var t1;
//last data datetime from socket
var ts_update =0;
//last data datetime of graph update
var ts_graph_update =0;
//flag pause/play
var is_pause = false;
//array of data get from listener
var my_data = [];

//web socket uri
/*for(i=0;i<100;i++)
{
   var DataItem = {ts:1000+i,value:i};
   data.push(DataItem);
   
   alert(data[i].ts);
}*/

//window.onload = onload;

$(document).ready(function () {
    //var t_current = 0;
	
	if ("WebSocket" in window) {	   
	   // Let us open a web socket
	   var ws = new WebSocket("ws://localhost:8080");		
	   //var ws = new WebSocket(wsUri);
	   ws.onopen = function() {		  
		  // Web Socket is connected, send data using send()
		ws.send("Hello");
		  //alert("Message is sent...");
		//alert('ws open');
		  //console.log("web socket open");
	   };
		
	   ws.onmessage = function (evt) { 
         //alert('ws data');
	    //console.log("web socket msg receipt");
		  //console.log("msg: "+evt.data);
		  var msg = JSON.parse(evt.data);
		  //var timestamp = date.getTime();
		  //if(ts_update==0 || msg.ts>=ts_update-1000)
		  //{
			//if(msg.ts>=ts_update-1000 && msg.ts>=ts_update-1900)
			//{
				var DataItem = {ts:msg.ts,value:msg.value};				
				my_data.push(DataItem);				
				
				console.log(msg.ts);
				console.log(msg.value);
				
				setGraph(msg);
				//setData(msg.value);
				//setLabels(msg.ts);

				var myLineChart = new Chart(ctx).Line(data, options);
				
			//}
		  //}
	   };
	   
	   ws.onerror = function (evt) {
            console.log("WebSocket ERROR: " + JSON.stringify(evt, null, 4));
       };
		
	   ws.onclose = function() { 
       alert('ws close');
		  //console.log("web socket closed");
	   };
	} else {
	  
	   // The browser doesn't support WebSocket
	   alert("WebSocket NOT supported by your Browser!");
	}				
	//t1 alarm check every 1s
	//var t1 = setInterval(chkAlarm,1000);


/*function chkAlarm()
{
  if(ts_update<current timestamp-X sec) //X sec depends on alarm condition
  {
     //alarm
	 //set alarm light to red	 
  }else{
     //clear alarm
	 //set alarm light to green
  }
}*/


 var ctx = document.getElementById("myChart").getContext("2d");
 var timestamp = + new Date();
  var data = {
    labels: ['1','2','3','4','5','6','7','8','9','10','11','12','13','14','15','16','17','18','19','20','21','22','23','24','25','26','27','28','29','30'],
    datasets: [{
      label: "initial dataset",
      fillColor: "rgba(220,220,220,0.2)",
      strokeColor: "rgba(220,220,220,1)",
      pointColor: "rgba(220,220,220,1)",
      pointStrokeColor: "#fff",
      pointHighlightFill: "#fff",
      pointHighlightStroke: "rgba(220,220,220,1)",
	  spanGaps: false,
      data: [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]
    }]
  };
  
  var options = {
    animation: false,
    //Boolean - If we want to override with a hard coded scale
    scaleOverride: true,
    //** Required if scaleOverride is true **
    //Number - The number of steps in a hard coded scale
    scaleSteps: 10,
    //Number - The value jump in the hard coded scale
    scaleStepWidth: 10,
    //Number - The scale starting value
    scaleStartValue: 0
  };

  var myLineChart = new Chart(ctx).Line(data, options);

  function setGraph(m){    
    //if(t_current>30)
	  //t_current=0;
	  
    data.labels.push(ts_time(m.ts));
	//data.labels.push(t_current.toString());
    data.labels.shift();
	
	if(!is_pause){
		data.datasets[0].data.push(m.value.toString());	
	}else{
		data.datasets[0].data.push(Number.NaN);	
	}
	data.datasets[0].data.shift();  
	
	//t_current = t_current+1;
  }  
  
  function ts_time(ts)
  {
	var date = new Date(ts);
	// Hours part from the timestamp
	var hours = date.getHours();
	// Minutes part from the timestamp
	var minutes = "0" + date.getMinutes();
	// Seconds part from the timestamp
	var seconds = "0" + date.getSeconds();

	// Will display time in 10:30:23 format
	var formattedTime = hours + ':' + minutes.substr(-2) + ':' + seconds.substr(-2);  
	
	return formattedTime;
  }
  
});

function PlayPause(a)
{     
 is_pause = a; 
}

</script>

</head>

<body>

  <body>
    <a href='javascript:void(0);' onclick='PlayPause(true);'>Pause</a>&nbsp;|<a href='javascript:void(0);' onclick='PlayPause(false);'>Play</a>&nbsp;
    <canvas id="myChart" width="400" height="400"></canvas>
  </body>

</html>